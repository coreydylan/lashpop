"use client"

import { useState, useEffect } from "react"
import { Upload as UploadIcon, Users, X, Grid3x3, LayoutGrid } from "lucide-react"
import Link from "next/link"
import { FileUploader } from "./components/FileUploader"
import { AssetGrid } from "./components/AssetGrid"
import { FilterSelector } from "./components/FilterSelector"
import { TagSelector } from "./components/TagSelector"
// import { SetSelector } from "./components/SetSelector" // FEATURE FLAG: Sets disabled
import { TeamMemberSelector } from "./components/TeamMemberSelector"
import { PhotoLightbox } from "./components/PhotoLightbox"

interface Asset {
  id: string
  fileName: string
  filePath: string
  fileType: "image" | "video"
  uploadedAt: Date
  teamMemberId?: string
  color?: "brown" | "black"
  length?: "S" | "M" | "L"
  curl?: "1" | "2" | "3" | "4"
}

interface TeamMember {
  id: string
  name: string
  imageUrl: string
}

interface ActiveFilter {
  categoryId: string
  categoryName: string
  categoryDisplayName: string
  categoryColor?: string
  optionId: string
  optionName: string
  optionDisplayName: string
  imageUrl?: string
}

export default function DAMPage() {
  const [assets, setAssets] = useState<Asset[]>([])
  const [allAssets, setAllAssets] = useState<Asset[]>([])
  const [teamMembers, setTeamMembers] = useState<TeamMember[]>([])
  const [selectedAssets, setSelectedAssets] = useState<string[]>([])
  const [isLoading, setIsLoading] = useState(true)
  const [activeFilters, setActiveFilters] = useState<ActiveFilter[]>([])
  const [uploadingAssetIds, setUploadingAssetIds] = useState<string[]>([])
  // FEATURE FLAG: Sets disabled
  // const [activeSets, setActiveSets] = useState<any[]>([])
  // const [setTaggingMode, setSetTaggingMode] = useState<{ setId: string; stage: "before" | "during" | "after" } | null>(null)

  // Omni-bar state (used for both filtering and bulk tagging)
  const [omniTeamMemberId, setOmniTeamMemberId] = useState<string | undefined>()
  const [omniTags, setOmniTags] = useState<any[]>([])
  const [existingTags, setExistingTags] = useState<Map<string, number>>(new Map()) // tag id -> count

  // Grid view state
  const [gridViewMode, setGridViewMode] = useState<"square" | "aspect">("square")

  // Upload panel state
  const [isUploadOpen, setIsUploadOpen] = useState(false)

  // Fetch initial data
  useEffect(() => {
    fetchAssets()
    fetchTeamMembers()
  }, [])

  const fetchAssets = async () => {
    try {
      const response = await fetch("/api/dam/assets")
      const data = await response.json()
      const fetchedAssets = data.assets || []
      setAllAssets(fetchedAssets)
      applyFilters(fetchedAssets, activeFilters)
    } catch (error) {
      console.error("Failed to fetch assets:", error)
    } finally {
      setIsLoading(false)
    }
  }

  const applyFilters = (assetsToFilter: Asset[], filters: ActiveFilter[]) => {
    if (filters.length === 0) {
      setAssets(assetsToFilter)
      return
    }

    let filtered = assetsToFilter

    // Group filters by category
    const filtersByCategory = filters.reduce((acc, filter) => {
      if (!acc[filter.categoryName]) {
        acc[filter.categoryName] = []
      }
      acc[filter.categoryName].push(filter)
      return acc
    }, {} as Record<string, ActiveFilter[]>)

    // Apply filters (OR within category, AND across categories)
    Object.entries(filtersByCategory).forEach(([categoryName, categoryFilters]) => {
      if (categoryName === "team") {
        // Filter by team member
        const teamMemberIds = categoryFilters.map(f => f.optionId)
        filtered = filtered.filter(asset =>
          asset.teamMemberId && teamMemberIds.includes(asset.teamMemberId)
        )
      } else {
        // Filter by tags
        const tagIds = categoryFilters.map(f => f.optionId)
        filtered = filtered.filter(asset =>
          asset.tags?.some(tag => tagIds.includes(tag.id))
        )
      }
    })

    setAssets(filtered)
  }

  const handleFiltersChange = (filters: ActiveFilter[]) => {
    // Only apply filters if not in selection mode
    if (selectedAssets.length === 0) {
      setActiveFilters(filters)
      applyFilters(allAssets, filters)
    }
  }

  const handleOmniTagsChange = (tags: any[]) => {
    setOmniTags(tags)
  }

  const fetchTeamMembers = async () => {
    try {
      const response = await fetch("/api/dam/team-members")
      const data = await response.json()
      setTeamMembers(data.teamMembers || [])
    } catch (error) {
      console.error("Failed to fetch team members:", error)
    }
  }


  const handleUploadComplete = (newAssets: Asset[], keepSelected: boolean) => {
    // Refresh the entire asset list to show new uploads
    fetchAssets()

    if (!keepSelected) {
      // User clicked "Skip Initial Tagging" - clear selection
      setSelectedAssets([])
      setUploadingAssetIds([])
      setOmniTags([])
      setExistingTags(new Map())
    }
    // If keepSelected = true, the assets remain selected for tagging
  }

  const handleUploadingIdsChange = (assetIds: string[]) => {
    // Clear any existing selection to prevent state conflicts
    // This ensures clean state when upload starts
    setUploadingAssetIds(assetIds)
    setSelectedAssets(assetIds)
    setOmniTags([]) // Clear any pending tags from previous selection
    setExistingTags(new Map()) // Clear existing tags display
  }

  const handleSelectionChange = (selectedIds: string[]) => {
    setSelectedAssets(selectedIds)

    if (selectedIds.length === 0) {
      // Clear selection mode
      setOmniTeamMemberId(undefined)
      setOmniTags([])
      setExistingTags(new Map())
    } else {
      // Calculate existing tags on selected assets (including team members)
      const selectedAssetsData = assets.filter(a => selectedIds.includes(a.id))
      const tagCounts = new Map<string, number>()

      selectedAssetsData.forEach(asset => {
        // Count regular tags
        asset.tags?.forEach(tag => {
          tagCounts.set(tag.id, (tagCounts.get(tag.id) || 0) + 1)
        })

        // Count team member as a "tag"
        if (asset.teamMemberId) {
          tagCounts.set(`team-${asset.teamMemberId}`, (tagCounts.get(`team-${asset.teamMemberId}`) || 0) + 1)
        }
      })

      setExistingTags(tagCounts)
      setOmniTags([]) // Clear any pending tags
    }
  }

  const handleApplyTags = async () => {
    if (omniTags.length === 0) return

    try {
      // Separate team member tags from regular tags
      const teamMemberTags = omniTags.filter(t => t.category.name === "team")
      const regularTags = omniTags.filter(t => t.category.name !== "team")

      // Apply team member assignments
      if (teamMemberTags.length > 0) {
        // Only support one team member at a time
        const teamMemberId = teamMemberTags[0].id
        const response = await fetch("/api/dam/assets/assign-team", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            assetIds: selectedAssets,
            teamMemberId
          })
        })

        if (!response.ok) {
          throw new Error("Failed to assign team member")
        }
      }

      // Apply regular tags
      if (regularTags.length > 0) {
        const response = await fetch("/api/dam/assets/bulk-tag", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            assetIds: selectedAssets,
            tagIds: regularTags.map(t => t.id),
            additive: true // Add to existing tags, don't replace
          })
        })

        if (!response.ok) {
          throw new Error("Failed to save tags")
        }
      }

      // Refresh assets
      await fetchAssets()
      setSelectedAssets([])
      setOmniTags([])
      setExistingTags(new Map())
    } catch (error) {
      console.error("Failed to save tags:", error)
    }
  }

  const handleRemoveTag = async (tagId: string, count: number) => {
    const isTeamMemberTag = tagId.startsWith('team-')
    const label = isTeamMemberTag ? "team member" : "tag"

    if (!confirm(`Remove this ${label} from ${count} image${count !== 1 ? 's' : ''}?`)) return

    try {
      if (isTeamMemberTag) {
        // Remove team member from selected assets
        const response = await fetch("/api/dam/assets/remove-team", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            assetIds: selectedAssets
          })
        })

        if (!response.ok) {
          throw new Error("Failed to remove team member")
        }
      } else {
        // Remove regular tag from selected assets
        const response = await fetch("/api/dam/assets/remove-tag", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            assetIds: selectedAssets,
            tagId
          })
        })

        if (!response.ok) {
          throw new Error("Failed to remove tag")
        }
      }

      // Refresh assets
      await fetchAssets()

      // Update existing tags count
      const newExistingTags = new Map(existingTags)
      newExistingTags.delete(tagId)
      setExistingTags(newExistingTags)
    } catch (error) {
      console.error("Failed to remove tag:", error)
    }
  }

  const handleDelete = async (assetIds: string[]) => {
    try {
      const response = await fetch("/api/dam/delete", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          assetIds
        })
      })

      if (response.ok) {
        // Refresh assets
        await fetchAssets()
        setSelectedAssets([])
      }
    } catch (error) {
      console.error("Failed to delete assets:", error)
    }
  }

  // FEATURE FLAG: Sets disabled
  // const handleSetCreated = (newSet: any) => {
  //   setActiveSets((prev) => [...prev, newSet])
  // }

  // const handleSetStageClick = (setId: string, stage: "before" | "during" | "after") => {
  //   // Enter set tagging mode
  //   setSetTaggingMode({ setId, stage })
  //   setSelectedAssets([]) // Clear any existing selection
  // }

  // const handleAssetClickInSetMode = async (asset: any) => {
  //   if (!setTaggingMode) return

  //   try {
  //     const response = await fetch("/api/dam/sets/add-photo", {
  //       method: "POST",
  //       headers: {
  //         "Content-Type": "application/json"
  //       },
  //       body: JSON.stringify({
  //         setId: setTaggingMode.setId,
  //         assetId: asset.id,
  //         stage: setTaggingMode.stage
  //       })
  //     })

  //     if (!response.ok) {
  //       throw new Error("Failed to add photo to set")
  //     }

  //     // Refresh assets to show updated set tags
  //     await fetchAssets()
  //   } catch (error) {
  //     console.error("Failed to add photo to set:", error)
  //   }
  // }

  // const exitSetTaggingMode = () => {
  //   setSetTaggingMode(null)
  // }

  return (
    <PhotoLightbox
      selectedAssetIds={selectedAssets}
      onSelectionChange={handleSelectionChange}
      assets={assets}
    >
      <div className="min-h-screen bg-cream">
      {/* Header */}
      <header className="bg-cream">
        <div className="max-w-7xl mx-auto px-6 py-6">
          <div className="flex items-center justify-between">
            <div>
              <img
                src="/lashpop-images/branding/logo.png"
                alt="LashPop Studios"
                className="h-10 w-auto mb-2"
                style={{
                  filter: 'brightness(0) saturate(100%) invert(72%) sepia(12%) saturate(635%) hue-rotate(316deg) brightness(95%) contrast(88%)'
                }}
              />
              <h1 className="text-xs font-semibold text-dune uppercase tracking-wider">
                Digital Asset Management
              </h1>
            </div>

            <div className="flex items-center gap-3">
              <button
                onClick={() => setIsUploadOpen(!isUploadOpen)}
                className={`btn ${isUploadOpen ? 'btn-primary' : 'btn-secondary'}`}
              >
                <UploadIcon className="w-5 h-5" />
                <span className="hidden sm:inline">Upload</span>
              </button>
              <Link
                href="/dam/team"
                className="btn btn-secondary"
              >
                <Users className="w-5 h-5" />
                <span className="hidden sm:inline">Team</span>
              </Link>
            </div>
          </div>
        </div>
      </header>

      {/* Sticky Omni Control Bar (Filters / Bulk Tagging) */}
      <div className="sticky top-0 z-30 bg-cream/95 backdrop-blur-sm">
        <div className="max-w-7xl mx-auto px-6 py-4">
          <div className={`arch-full overflow-hidden transition-colors ${
            selectedAssets.length > 0
              ? "bg-dusty-rose/30"
              : "bg-warm-sand/30"
          }`}>
                      </span>
                      <button
                        onClick={() => setGridViewMode(gridViewMode === "square" ? "aspect" : "square")}
                        className="p-2 hover:bg-dune/10 rounded-full transition-colors"
                      >
                        {gridViewMode === "square" ? (
                          <LayoutGrid className="w-4 h-4 text-sage" />
                        ) : (
                          <Grid3x3 className="w-4 h-4 text-sage" />
                        )}
                      </button>
                    </>
                  )}
                </div>
                {selectedAssets.length > 0 && omniTags.length > 0 && (
                  <button
                    onClick={handleApplyTags}
                    className="px-6 py-2 rounded-full bg-dusty-rose text-cream font-semibold hover:bg-dusty-rose/80 transition-colors shadow-lg"
                  >
                    Apply
                  </button>
                )}
              </div>
              {/* Bottom row: Chips */}
              <div className="px-6 py-3 overflow-x-auto">
                <div className="flex items-center gap-3">
                  {/* Content */}
                  <div className="flex-1 min-w-0 overflow-x-auto pb-1">
                    <div className="flex items-center gap-3">
                      {selectedAssets.length > 0 ? (
                        <>
                          {/* Selection Mode: Show existing tags with counts */}
                          {Array.from(existingTags.entries()).map(([tagId, count]) => {
                            // Check if this is a team member tag
                            const isTeamMemberTag = tagId.startsWith('team-')

                            if (isTeamMemberTag) {
                              const teamMemberId = tagId.replace('team-', '')
                              const teamMember = teamMembers.find(m => m.id === teamMemberId)
                              if (!teamMember) return null

                              return (
                                <div
                                  key={tagId}
                                  className="flex-shrink-0 flex items-center gap-1 arch-full overflow-hidden shadow-sm"
                                  style={{
                                    background: `linear-gradient(135deg, #BCC9C2 0%, #BCC9C2CC 100%)`
                                  }}
                                >
                                  <div className="flex items-center gap-2 px-3 py-1.5">
                                    <button
                                      onClick={() => handleRemoveTag(tagId, count)}
                                      className="flex items-center gap-1 hover:bg-black/10 rounded px-1 transition-colors"
                                    >
                                      <X className="w-3 h-3 text-cream" />
                                      <span className="text-xs font-bold text-cream">{count}</span>
                                    </button>
                                    {teamMember.imageUrl && (
                                      <img
                                        src={teamMember.imageUrl}
                                        alt={teamMember.name}
                                        className="w-5 h-5 rounded-full object-cover border border-cream/30"
                                      />
                                    )}
                                    <span className="text-xs font-semibold text-cream uppercase tracking-wide">
                                      Team
                                    </span>
                                    <span className="text-cream/80 text-xs">›</span>
                                    <span className="text-sm text-cream font-medium">
                                      {teamMember.name}
                                    </span>
                                  </div>
                                </div>
                              )
                            }

                            // Regular tag
                            const tag = assets
                              .flatMap(a => a.tags || [])
                              .find(t => t.id === tagId)
                            if (!tag) return null

                            return (
                              <div
                                key={tagId}
                                className="flex-shrink-0 flex items-center gap-1 arch-full overflow-hidden shadow-sm"
                                style={{
                                  background: `linear-gradient(135deg, ${tag.category.color || "#A19781"} 0%, ${tag.category.color || "#A19781"}CC 100%)`
                                }}
                              >
                                <div className="flex items-center gap-2 px-3 py-1.5">
                                  <button
                                    onClick={() => handleRemoveTag(tagId, count)}
                                    className="flex items-center gap-1 hover:bg-black/10 rounded px-1 transition-colors"
                                  >
                                    <X className="w-3 h-3 text-cream" />
                                    <span className="text-xs font-bold text-cream">{count}</span>
                                  </button>
                                  <span className="text-xs font-semibold text-cream uppercase tracking-wide">
                                    {tag.category.displayName}
                                  </span>
                                  <span className="text-cream/80 text-xs">›</span>
                                  <span className="text-sm text-cream font-medium">
                                    {tag.displayName}
                                  </span>
                                </div>
                              </div>
                            )
                          })}

                          {/* New tags to add */}
                          {omniTags.map((tag) => {
                            const isTeamTag = tag.category.name === "team"
                            const teamMember = isTeamTag ? teamMembers.find(m => m.id === tag.id) : null

                            return (
                              <div
                                key={`new-${tag.id}`}
                                className="flex-shrink-0 flex items-center gap-1 arch-full overflow-hidden shadow-sm border-2 border-cream/40"
                                style={{
                                  background: `linear-gradient(135deg, ${tag.category.color || "#A19781"} 0%, ${tag.category.color || "#A19781"}CC 100%)`
                                }}
                              >
                                <div className="flex items-center gap-2 px-3 py-1.5">
                                  {isTeamTag && teamMember?.imageUrl && (
                                    <img
                                      src={teamMember.imageUrl}
                                      alt={tag.displayName}
                                      className="w-5 h-5 rounded-full object-cover border border-cream/30"
                                    />
                                  )}
                                  <span className="text-xs font-semibold text-cream uppercase tracking-wide">
                                    {tag.category.displayName}
                                  </span>
                                  <span className="text-cream/80 text-xs">›</span>
                                  <span className="text-sm text-cream font-medium">
                                    {tag.displayName}
                                  </span>
                                </div>
                                <button
                                  onClick={() => setOmniTags(omniTags.filter(t => t.id !== tag.id))}
                                  className="px-2 py-1.5 hover:bg-black/10 transition-colors"
                                >
                                  <X className="w-3.5 h-3.5 text-cream" />
                                </button>
                              </div>
                            )
                          })}

                          {/* FEATURE FLAG: Sets disabled */}
                          {/* {activeSets.map((set) => {
                            const teamMember = teamMembers.find(m => m.id === set.teamMemberId)
                            return (
                              <div
                                key={set.id}
                                className="flex-shrink-0 flex items-center gap-1 arch-full overflow-hidden shadow-sm bg-dusty-rose"
                              >
                                <div className="flex items-center gap-2 px-3 py-1.5">
                                  {teamMember?.imageUrl && (
                                    <img
                                      src={teamMember.imageUrl}
                                      alt={teamMember.name}
                                      className="w-5 h-5 rounded-full object-cover border border-cream/30"
                                    />
                                  )}
                                  <span className="text-xs font-semibold text-cream uppercase tracking-wide">
                                    Set
                                  </span>
                                  <span className="text-cream/80 text-xs">›</span>
                                  <span className="text-sm text-cream font-medium">
                                    {teamMember?.name}
                                  </span>
                                </div>

                                <div className="flex items-center gap-1 px-2 border-l border-cream/20">
                                  <button
                                    onClick={() => handleSetStageClick(set.id, "before")}
                                    className={`px-2 py-1 rounded text-xs font-bold text-cream transition-colors ${
                                      setTaggingMode?.setId === set.id && setTaggingMode?.stage === "before"
                                        ? "bg-cream/30"
                                        : "hover:bg-cream/10"
                                    }`}
                                  >
                                    +B
                                  </button>
                                  <button
                                    onClick={() => handleSetStageClick(set.id, "during")}
                                    className={`px-2 py-1 rounded text-xs font-bold text-cream transition-colors ${
                                      setTaggingMode?.setId === set.id && setTaggingMode?.stage === "during"
                                        ? "bg-cream/30"
                                        : "hover:bg-cream/10"
                                    }`}
                                  >
                                    +D
                                  </button>
                                  <button
                                    onClick={() => handleSetStageClick(set.id, "after")}
                                    className={`px-2 py-1 rounded text-xs font-bold text-cream transition-colors ${
                                      setTaggingMode?.setId === set.id && setTaggingMode?.stage === "after"
                                        ? "bg-cream/30"
                                        : "hover:bg-cream/10"
                                    }`}
                                  >
                                    +A
                                  </button>
                                </div>
                              </div>
                            )
                          })} */}

                          {/* Add Tag button */}
                          <TagSelector
                            selectedTags={omniTags}
                            onTagsChange={handleOmniTagsChange}
                          />

                          {/* FEATURE FLAG: Sets disabled */}
                          {/* <SetSelector
                            activeSets={activeSets}
                            teamMembers={teamMembers}
                            onSetCreated={handleSetCreated}
                            onSetStageClick={handleSetStageClick}
                          /> */}
                        </>
                      ) : (
                        /* Filter Mode */
                        <FilterSelector
                          activeFilters={activeFilters}
                          onFiltersChange={handleFiltersChange}
                        />
                      )}
                    </div>
                  </div>

                  {/* Right side */}
                  <div className="flex-shrink-0 pl-4 flex items-center gap-3">
                    {selectedAssets.length > 0 ? (
                      <>
                        <div className="flex items-center gap-2">
                          <span className="body text-dune whitespace-nowrap font-semibold">
                            {selectedAssets.length} selected
                          </span>
                          <button
                            onClick={() => {
                              setSelectedAssets([])
                              setOmniTags([])
                              setExistingTags(new Map())
                            }}
                            className="p-1 hover:bg-dune/10 rounded-full transition-colors"
                            title="Clear selection"
                          >
                            <X className="w-4 h-4 text-dune" />
                          </button>
                        </div>
                        {omniTags.length > 0 && (
                          <button
                            onClick={handleApplyTags}
                            className="px-6 py-2 rounded-full bg-dusty-rose text-cream font-semibold hover:bg-dusty-rose/80 transition-colors shadow-lg"
                          >
                            Apply
                          </button>
                        )}
                      </>
                    ) : (
                      <div className="flex items-center gap-3">
                        <span className="body text-sage whitespace-nowrap">
                          {assets.length} asset{assets.length !== 1 ? "s" : ""}
                          {activeFilters.length > 0 && ` (${allAssets.length} total)`}
                        </span>
                        <button
                          onClick={() => setGridViewMode(gridViewMode === "square" ? "aspect" : "square")}
                          className="p-2 hover:bg-dune/10 rounded-full transition-colors"
                          title={gridViewMode === "square" ? "Switch to aspect ratio view" : "Switch to square grid view"}
                        >
                          {gridViewMode === "square" ? (
                            <LayoutGrid className="w-4 h-4 text-sage" />
                          ) : (
                            <Grid3x3 className="w-4 h-4 text-sage" />
                          )}
                        </button>
                      </div>
                    )}
                  </div>
                </div>
              </div>

          {/* Inline Upload Dropbox */}
          <FileUploader
            onUploadComplete={handleUploadComplete}
            onUploadingIdsChange={handleUploadingIdsChange}
          />

          {/* FEATURE FLAG: Sets disabled */}
          {/* {setTaggingMode && (
            <div className="arch-full bg-dusty-rose/20 border-2 border-dusty-rose/40 p-4 flex items-center justify-between">
              <div className="flex items-center gap-3">
                <div className="w-10 h-10 rounded-full bg-dusty-rose flex items-center justify-center">
                  <span className="text-cream font-bold text-sm">
                    {setTaggingMode.stage === "before" ? "B" : setTaggingMode.stage === "during" ? "D" : "A"}
                  </span>
                </div>
                <div>
                  <p className="body text-dune font-semibold">
                    Set Tagging Mode: {setTaggingMode.stage.charAt(0).toUpperCase() + setTaggingMode.stage.slice(1)}
                  </p>
                  <p className="caption text-sage">
                    Click any photo to add it to this stage
                  </p>
                </div>
              </div>
              <button
                onClick={exitSetTaggingMode}
                className="btn btn-secondary"
              >
                Exit Tagging Mode
              </button>
            </div>
          )} */}

          {/* Gallery */}
          {isLoading ? (
            <div className="flex items-center justify-center py-16">
              <div className="animate-spin w-12 h-12 border-4 border-dusty-rose border-t-transparent rounded-full" />
            </div>
          ) : assets.length === 0 ? (
            <div className="text-center py-16">
              <div className="w-20 h-20 bg-warm-sand/50 arch-full flex items-center justify-center mx-auto mb-6">
                <UploadIcon className="w-10 h-10 text-sage" />
              </div>
              <h3 className="h3 text-dune mb-3">
                No assets yet
              </h3>
              <p className="body text-sage">
                Drop files in the box above or tap to browse
              </p>
            </div>
          ) : (
            <AssetGrid
              assets={assets}
              onSelectionChange={handleSelectionChange}
              onDelete={handleDelete}
              gridViewMode={gridViewMode}
            />
          )}
        </div>
      </main>
      </div>
    </PhotoLightbox>
  )
}
